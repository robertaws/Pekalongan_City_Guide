Index: app/src/main/java/com/binus/pekalongancityguide/Layout/AddDestination.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.binus.pekalongancityguide.Layout;\r\n\r\nimport android.app.ProgressDialog;\r\nimport android.content.Context;\r\nimport android.content.Intent;\r\nimport android.graphics.Bitmap;\r\nimport android.net.Uri;\r\nimport android.os.AsyncTask;\r\nimport android.os.Bundle;\r\nimport android.provider.MediaStore;\r\nimport android.text.TextUtils;\r\nimport android.util.Log;\r\nimport android.view.inputmethod.InputMethodManager;\r\nimport android.widget.Toast;\r\n\r\nimport androidx.annotation.NonNull;\r\nimport androidx.annotation.Nullable;\r\nimport androidx.appcompat.app.AlertDialog;\r\nimport androidx.appcompat.app.AppCompatActivity;\r\n\r\nimport com.binus.pekalongancityguide.R;\r\nimport com.binus.pekalongancityguide.databinding.ActivityAddDestinationBinding;\r\nimport com.bumptech.glide.Glide;\r\nimport com.google.android.gms.common.api.ApiException;\r\nimport com.google.android.gms.tasks.Task;\r\nimport com.google.android.libraries.places.api.Places;\r\nimport com.google.android.libraries.places.api.model.AutocompleteSessionToken;\r\nimport com.google.android.libraries.places.api.model.OpeningHours;\r\nimport com.google.android.libraries.places.api.model.PhotoMetadata;\r\nimport com.google.android.libraries.places.api.model.Place;\r\nimport com.google.android.libraries.places.api.model.TypeFilter;\r\nimport com.google.android.libraries.places.api.net.FetchPhotoRequest;\r\nimport com.google.android.libraries.places.api.net.FetchPlaceRequest;\r\nimport com.google.android.libraries.places.api.net.FindAutocompletePredictionsRequest;\r\nimport com.google.android.libraries.places.api.net.FindAutocompletePredictionsResponse;\r\nimport com.google.android.libraries.places.api.net.PlacesClient;\r\nimport com.google.firebase.auth.FirebaseAuth;\r\nimport com.google.firebase.database.DataSnapshot;\r\nimport com.google.firebase.database.DatabaseError;\r\nimport com.google.firebase.database.DatabaseReference;\r\nimport com.google.firebase.database.FirebaseDatabase;\r\nimport com.google.firebase.database.ValueEventListener;\r\nimport com.google.firebase.storage.FirebaseStorage;\r\nimport com.google.firebase.storage.StorageReference;\r\n\r\nimport org.json.JSONArray;\r\nimport org.json.JSONException;\r\nimport org.json.JSONObject;\r\n\r\nimport java.io.BufferedReader;\r\nimport java.io.InputStream;\r\nimport java.io.InputStreamReader;\r\nimport java.net.HttpURLConnection;\r\nimport java.net.URL;\r\nimport java.util.ArrayList;\r\nimport java.util.Arrays;\r\nimport java.util.HashMap;\r\nimport java.util.List;\r\n\r\nimport static com.binus.pekalongancityguide.BuildConfig.MAPS_API_KEY;\r\n\r\npublic class AddDestination extends AppCompatActivity {\r\n    public static final String TAG = \"ADD_IMAGE_TAG\";\r\n    private static final int PICK_IMAGE_REQUEST = 1;\r\n    PlacesClient placesClient;\r\n    ArrayList<String> categoriesTitleArrayList, categoryIdArrayList;\r\n    private ActivityAddDestinationBinding binding;\r\n    private FirebaseAuth firebaseAuth;\r\n    private Uri imageUri;\r\n    private ProgressDialog progressDialog;\r\n    private String title = \"\";\r\n    private String desc = \"\";\r\n    private String selectedCategoryId, selectedCategoryTitle;\r\n\r\n    @Override\r\n    protected void onCreate(Bundle savedInstanceState) {\r\n        super.onCreate(savedInstanceState);\r\n        Places.initialize(getApplicationContext(), MAPS_API_KEY);\r\n        binding = ActivityAddDestinationBinding.inflate(getLayoutInflater());\r\n        setContentView(binding.getRoot());\r\n        firebaseAuth = FirebaseAuth.getInstance();\r\n        loadCategory();\r\n        progressDialog = new ProgressDialog(this);\r\n        progressDialog.setTitle(\"Please wait\");\r\n        progressDialog.setCanceledOnTouchOutside(false);\r\n\r\n        binding.backtoAdmin.setOnClickListener(v -> onBackPressed());\r\n        binding.addPicture.setOnClickListener(v -> addPhoto());\r\n        binding.categoryPick.setOnClickListener(v -> showCategoryDialog());\r\n        binding.addBtn.setOnClickListener(v -> {\r\n            InputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);\r\n            imm.hideSoftInputFromWindow(binding.getRoot().getWindowToken(), 0);\r\n            validateData();\r\n        });\r\n\r\n    }\r\n\r\n    private void validateData() {\r\n        Log.d(TAG, \"validate data : validating data \");\r\n        title = binding.titleEt.getText().toString().trim();\r\n        desc = binding.descEt.getText().toString().trim();\r\n        FindAutocompletePredictionsRequest request;\r\n        if (TextUtils.isEmpty(title)) {\r\n            binding.titleEt.setError(\"Enter destination title!\");\r\n        } else if (TextUtils.isEmpty(selectedCategoryTitle)) {\r\n            binding.categoryPick.setError(\"Pick a category!\");\r\n        } else {\r\n            placesClient = Places.createClient(this);\r\n            List<Place.Field> placeFields = Arrays.asList(\r\n                    Place.Field.ID,\r\n                    Place.Field.NAME,\r\n                    Place.Field.ADDRESS,\r\n                    Place.Field.LAT_LNG,\r\n                    Place.Field.RATING,\r\n                    Place.Field.OPENING_HOURS,\r\n                    Place.Field.PHONE_NUMBER,\r\n                    Place.Field.PHOTO_METADATAS,\r\n                    Place.Field.TYPES);\r\n            AutocompleteSessionToken token = AutocompleteSessionToken.newInstance();\r\n            request = FindAutocompletePredictionsRequest.builder()\r\n                    .setTypeFilter(TypeFilter.ESTABLISHMENT)\r\n                    .setSessionToken(token)\r\n                    .setQuery(title)\r\n                    .build();\r\n            Task<FindAutocompletePredictionsResponse> task = placesClient.findAutocompletePredictions(request);\r\n            task.addOnSuccessListener(response -> {\r\n                if (!response.getAutocompletePredictions().isEmpty()) {\r\n                    String placeId = response.getAutocompletePredictions().get(0).getPlaceId();\r\n                    Log.d(TAG, \"Place ID: \" + placeId);\r\n                    String url = \"https://maps.googleapis.com/maps/api/place/details/json?placeid=\" + placeId + \"&key=\" + MAPS_API_KEY;\r\n                    FetchPlaceRequest placeRequest = FetchPlaceRequest.builder(placeId, placeFields).build();\r\n                    placesClient.fetchPlace(placeRequest).addOnCompleteListener(task1 -> {\r\n                        if (task1.isSuccessful()) {\r\n                            Place place = task1.getResult().getPlace();\r\n                            String address = place.getAddress();\r\n                            String phoneNumber = place.getPhoneNumber();\r\n                            OpeningHours openingHours = place.getOpeningHours();\r\n                            double latitude = place.getLatLng().latitude;\r\n                            double longitude = place.getLatLng().longitude;\r\n                            double rating = place.getRating();\r\n                            Log.d(TAG, \"Address: \" + address);\r\n                            Log.d(TAG, \"Latitude: \" + latitude);\r\n                            Log.d(TAG, \"Longitude: \" + longitude);\r\n                            Log.d(TAG, \"Rating: \" + rating);\r\n                            Log.d(TAG, \"Phone number: \" + phoneNumber);\r\n                            if (TextUtils.isEmpty((desc))) {\r\n                                desc = String.valueOf(place.getTypes());\r\n                            }\r\n                            new GetReviewsTask() {\r\n                                @Override\r\n                                protected void onPostExecute(JSONArray reviews) {\r\n                                    if (reviews != null) {\r\n                                        Log.d(TAG, \"Reviews: \" + reviews);\r\n                                        if (openingHours != null) {\r\n                                            uploadtoStorage(placeId, address, latitude, longitude, rating, reviews, phoneNumber, openingHours.getWeekdayText(), place);\r\n                                        } else {\r\n                                            uploadtoStorage(placeId, address, latitude, longitude, rating, reviews, phoneNumber, null, place);\r\n                                        }\r\n                                    } else {\r\n                                        Toast.makeText(AddDestination.this, \"Error getting reviews\", Toast.LENGTH_SHORT).show();\r\n                                    }\r\n                                }\r\n                            }.execute(url);\r\n                        } else {\r\n                            Toast.makeText(AddDestination.this, \"Error getting location details: \" + task1.getException().getMessage(), Toast.LENGTH_SHORT).show();\r\n                        }\r\n                    });\r\n                } else {\r\n                    Toast.makeText(this, \"No location found for the given title\", Toast.LENGTH_SHORT).show();\r\n                }\r\n            });\r\n            task.addOnFailureListener(e -> {\r\n                Log.e(TAG, \"Error getting place ID: \" + e.getMessage());\r\n                Toast.makeText(this, \"Error getting location from title: \" + e.getMessage(), Toast.LENGTH_SHORT).show();\r\n            });\r\n        }\r\n    }\r\n\r\n    private void uploadtoStorage(String placeId, String address, double lat, double lng, double rating, JSONArray reviews, String phoneNumber, List<String> weekday, Place place) {\r\n        Log.d(TAG, \"uploadtoStorage : uploading to storage\");\r\n        progressDialog.setMessage(\"Uploading image\");\r\n        progressDialog.show();\r\n        if (imageUri == null) {\r\n            List<PhotoMetadata> photoMetadataList = place.getPhotoMetadatas();\r\n            if (photoMetadataList != null) {\r\n                PhotoMetadata photoMetadata = photoMetadataList.get(0);\r\n                FetchPhotoRequest photoRequest = FetchPhotoRequest.builder(photoMetadata)\r\n                        .setMaxWidth(500)\r\n                        .setMaxHeight(300)\r\n                        .build();\r\n                placesClient.fetchPhoto(photoRequest).addOnSuccessListener(fetchPhotoResponse -> {\r\n                    Bitmap bitmap = fetchPhotoResponse.getBitmap();\r\n                    if (bitmap != null) { // Check if bitmap is not null\r\n                        imageUri = bitmapToUri(this, bitmap);\r\n                        Log.d(TAG, \"image uri: \" + imageUri);\r\n                        Glide.with(AddDestination.this)\r\n                                .load(imageUri)\r\n                                .centerCrop()\r\n                                .into(binding.addPicture);\r\n                    } else {\r\n                        // Handle error when bitmap is null\r\n                    }\r\n                }).addOnFailureListener(exception -> {\r\n                    // Handle error\r\n                    if (exception instanceof ApiException) {\r\n                        ApiException apiException = (ApiException) exception;\r\n                        int statusCode = apiException.getStatusCode();\r\n                        Log.e(TAG, \"Place photo not found: \" + exception.getMessage());\r\n                    }\r\n                });\r\n            }\r\n        } else {\r\n            // Use a default image if imageUri is still null\r\n            imageUri = Uri.parse(\"android.resource://\" + getPackageName() + \"/\" + R.drawable.logo);\r\n        }\r\n\r\n// Check if imageUri is still null after the fetchPhoto call\r\n        if (imageUri == null) {\r\n            // Handle the case when imageUri is null\r\n            Log.e(TAG, \"Failed to fetch image, using default image\");\r\n            imageUri = Uri.parse(\"android.resource://\" + getPackageName() + \"/\" + R.drawable.logo);\r\n        }\r\n\r\n// Convert the bitmap to URI and set the image using Glide\r\n        Glide.with(AddDestination.this)\r\n                .load(imageUri)\r\n                .centerCrop()\r\n                .into(binding.addPicture);\r\n\r\n        long timestamp = System.currentTimeMillis();\r\n        String filePathandName = \"Destination/\" + timestamp;\r\n        StorageReference storageReference = FirebaseStorage.getInstance(\"gs://pekalongan-city-guide-5bf2e.appspot.com\").getReference(filePathandName);\r\n        storageReference.putFile(imageUri)\r\n                .addOnSuccessListener(taskSnapshot -> {\r\n                    Log.d(TAG, \"on success : Image uploaded to Storage\");\r\n                    Log.d(TAG, \"on success : getting image url\");\r\n                    Task<Uri> uriTask = taskSnapshot.getStorage().getDownloadUrl();\r\n                    while (!uriTask.isSuccessful()) ;\r\n                    String uploadedImageUrl = \"\" + uriTask.getResult();\r\n                    uploadtoDB(uploadedImageUrl, timestamp, placeId, address, lat, lng, rating, reviews, phoneNumber, weekday);\r\n                })\r\n                .addOnFailureListener(e -> {\r\n                    progressDialog.dismiss();\r\n                    Log.d(TAG, \"on Failure : Image upload failed due to \" + e.getMessage());\r\n                    Toast.makeText(AddDestination.this, \"Image upload failed due to \" + e.getMessage(), Toast.LENGTH_SHORT).show();\r\n                });\r\n\r\n    }\r\n\r\n    private void uploadtoDB(String uploadedImageUrl, long timestamp, String placeId, String address, double desLat, double desLong, double rating, JSONArray reviews, String phoneNumber, List<String> weekday) {\r\n        Log.d(TAG, \"uploadtoDB : uploading image to firebase DB\");\r\n        progressDialog.setMessage(\"Uploading image info\");\r\n        String uid = firebaseAuth.getUid();\r\n        HashMap<String, Object> hashMap = new HashMap<>();\r\n        hashMap.put(\"uid\", \"\" + uid);\r\n        hashMap.put(\"id\", \"\" + timestamp);\r\n        hashMap.put(\"title\", \"\" + title);\r\n        hashMap.put(\"description\", \"\" + desc);\r\n        hashMap.put(\"address\", \"\" + address);\r\n        hashMap.put(\"latitude\", \"\" + desLat);\r\n        hashMap.put(\"longitude\", \"\" + desLong);\r\n        hashMap.put(\"rating\", \"\" + rating);\r\n        hashMap.put(\"categoryId\", \"\" + selectedCategoryId);\r\n        hashMap.put(\"url\", \"\" + uploadedImageUrl);\r\n        hashMap.put(\"timestamp\", timestamp);\r\n        hashMap.put(\"placeId\", placeId);\r\n        hashMap.put(\"phoneNumber\", phoneNumber);\r\n\r\n        ArrayList<HashMap<String, Object>> reviewsList = new ArrayList<>();\r\n        for (int i = 0; i < reviews.length(); i++) {\r\n            try {\r\n                JSONObject review = reviews.getJSONObject(i);\r\n                HashMap<String, Object> reviewMap = new HashMap<>();\r\n                reviewMap.put(\"authorName\", review.getString(\"author_name\"));\r\n                reviewMap.put(\"rating\", review.getInt(\"rating\"));\r\n                reviewMap.put(\"text\", review.getString(\"text\"));\r\n                reviewsList.add(reviewMap);\r\n            } catch (JSONException e) {\r\n                e.printStackTrace();\r\n            }\r\n        }\r\n        hashMap.put(\"reviews\", reviewsList);\r\n        hashMap.put(\"openingHours\", weekday);\r\n\r\n        DatabaseReference reference = FirebaseDatabase.getInstance(\"https://pekalongan-city-guide-5bf2e-default-rtdb.asia-southeast1.firebasedatabase.app/\").getReference(\"Destination\");\r\n        reference.child(\"\" + timestamp)\r\n                .setValue(hashMap)\r\n                .addOnSuccessListener(aVoid -> {\r\n                    progressDialog.dismiss();\r\n                    Toast.makeText(getApplicationContext(), \"Image uploaded successfully\", Toast.LENGTH_LONG).show();\r\n                })\r\n                .addOnFailureListener(e -> {\r\n                    progressDialog.dismiss();\r\n                    Log.d(TAG, \"on Failure : \" + e.getMessage());\r\n                    Toast.makeText(AddDestination.this, \"Data upload failed due to \" + e.getMessage(), Toast.LENGTH_SHORT).show();\r\n                })\r\n                .addOnCompleteListener(task -> {\r\n                    if (task.isSuccessful()) {\r\n                        Log.d(TAG, \"uploadtoDB : Place ID successfully added to database\");\r\n                        getPlaceDetails(placeId);\r\n                        onBackPressed();\r\n                    }\r\n                });\r\n    }\r\n\r\n    private void loadCategory() {\r\n        Log.d(TAG, \"load Category : load Category \");\r\n        categoriesTitleArrayList = new ArrayList<>();\r\n        categoryIdArrayList = new ArrayList<>();\r\n        DatabaseReference reference = FirebaseDatabase.getInstance(\"https://pekalongan-city-guide-5bf2e-default-rtdb.asia-southeast1.firebasedatabase.app/\").getReference(\"Categories\");\r\n        reference.addValueEventListener(new ValueEventListener() {\r\n            @Override\r\n            public void onDataChange(@NonNull DataSnapshot snapshot) {\r\n                categoriesTitleArrayList.clear();\r\n                categoryIdArrayList.clear();\r\n                for (DataSnapshot dataSnapshot : snapshot.getChildren()) {\r\n                    String categoryId = \"\" + dataSnapshot.child(\"id\").getValue();\r\n                    String categoryTitle = \"\" + dataSnapshot.child(\"category\").getValue();\r\n                    categoriesTitleArrayList.add(categoryTitle);\r\n                    categoryIdArrayList.add(categoryId);\r\n                }\r\n            }\r\n\r\n            @Override\r\n            public void onCancelled(@NonNull DatabaseError error) {\r\n\r\n            }\r\n        });\r\n    }\r\n\r\n    private void showCategoryDialog() {\r\n        Log.d(TAG, \"Category dialog : showing dialog \");\r\n        String[] categoryArray = new String[categoriesTitleArrayList.size()];\r\n        for (int i = 0; i < categoriesTitleArrayList.size(); i++) {\r\n            categoryArray[i] = categoriesTitleArrayList.get(i);\r\n        }\r\n        AlertDialog.Builder builder = new AlertDialog.Builder(this);\r\n        builder.setTitle(\"Pick Category\")\r\n                .setItems(categoryArray, (dialog, which) -> {\r\n                    selectedCategoryTitle = categoriesTitleArrayList.get(which);\r\n                    selectedCategoryId = categoryIdArrayList.get(which);\r\n                    binding.categoryPick.setText(selectedCategoryTitle);\r\n                    Log.d(TAG, \"on Click : Selected Category :\" + selectedCategoryId + \" \" + selectedCategoryTitle);\r\n                })\r\n                .show();\r\n\r\n    }\r\n\r\n    private void addPhoto() {\r\n        Log.d(TAG, \"imageIntent : Start pick destination image\");\r\n        Intent intent = new Intent(Intent.ACTION_GET_CONTENT);\r\n        intent.setType(\"image/*\");\r\n        startActivityForResult(Intent.createChooser(intent, \"Select Picture\"), PICK_IMAGE_REQUEST);\r\n    }\r\n\r\n    @Override\r\n    protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {\r\n        super.onActivityResult(requestCode, resultCode, data);\r\n        if (requestCode == PICK_IMAGE_REQUEST && resultCode == RESULT_OK && data != null && data.getData() != null) {\r\n            Log.d(TAG, \"onActivityResult : Image picked\");\r\n            imageUri = data.getData();\r\n            Log.d(TAG, \"onActivityResult : URI : \" + imageUri);\r\n            Glide.with(AddDestination.this)\r\n                    .load(imageUri)\r\n                    .placeholder(R.drawable.person)\r\n                    .centerCrop()\r\n                    .into(binding.addPicture);\r\n        } else {\r\n            Log.d(TAG, \"onActivityResult : Cancelled pick image\");\r\n            Toast.makeText(this, \"Cancelled pick image\", Toast.LENGTH_SHORT).show();\r\n        }\r\n    }\r\n\r\n    private void getPlaceDetails(String placeId) {\r\n        Log.d(TAG, \"getPlaceDetails : getting place details\");\r\n        List<Place.Field> placeFields = Arrays.asList(Place.Field.NAME, Place.Field.LAT_LNG, Place.Field.ADDRESS);\r\n        FetchPlaceRequest request = FetchPlaceRequest.builder(placeId, placeFields).build();\r\n        PlacesClient placesClient = Places.createClient(this);\r\n        placesClient.fetchPlace(request)\r\n                .addOnSuccessListener((response) -> {\r\n                    Place place = response.getPlace();\r\n                    Log.d(TAG, \"Place details: \" + place.getName() + \", \" + place.getAddress() + \", \" + place.getLatLng());\r\n                })\r\n                .addOnFailureListener((exception) -> {\r\n                    Log.e(TAG, \"Place not found: \" + exception.getMessage());\r\n                });\r\n\r\n    }\r\n\r\n    public Uri bitmapToUri(Context context, Bitmap bitmap) {\r\n        String path = MediaStore.Images.Media.insertImage(context.getContentResolver(), bitmap, \"Title\", null);\r\n        return Uri.parse(path);\r\n    }\r\n\r\n    private static abstract class GetReviewsTask extends AsyncTask<String, Void, JSONObject> {\r\n        @Override\r\n        protected JSONObject doInBackground(String... params) {\r\n            String url = params[0];\r\n            JSONObject json = null;\r\n            try {\r\n                // Create the URL and open the connection\r\n                URL urlObj = new URL(url);\r\n                HttpURLConnection conn = (HttpURLConnection) urlObj.openConnection();\r\n                conn.setRequestMethod(\"GET\");\r\n\r\n                // Read the response from the connection\r\n                InputStream stream = conn.getInputStream();\r\n                BufferedReader reader = new BufferedReader(new InputStreamReader(stream));\r\n                StringBuilder response = new StringBuilder();\r\n                String line;\r\n                while ((line = reader.readLine()) != null) {\r\n                    response.append(line);\r\n                }\r\n                // Parse the JSON response\r\n                json = new JSONObject(response.toString());\r\n            } catch (Exception e) {\r\n                e.printStackTrace();\r\n            }\r\n            return json;\r\n        }\r\n\r\n        @Override\r\n        protected void onPostExecute(JSONObject json) {\r\n            if (json != null) {\r\n                try {\r\n                    // Extract the details and reviews from the JSON\r\n                    JSONObject result = json.getJSONObject(\"result\");\r\n                    JSONArray reviews = result.getJSONArray(\"reviews\");\r\n                    for (int i = 0; i < reviews.length(); i++) {\r\n                        JSONObject review = reviews.getJSONObject(i);\r\n                        String authorName = review.getString(\"author_name\");\r\n                        int reviewRating = review.getInt(\"rating\");\r\n                        String text = review.getString(\"text\");\r\n                        // Do something with the review data...\r\n                        Log.d(\"Review #\" + i, \"Author Name: \" + authorName);\r\n                        Log.d(\"Review #\" + i, \"Rating: \" + reviewRating);\r\n                        Log.d(\"Review #\" + i, \"Text: \" + text);\r\n                    }\r\n                    onPostExecute(reviews);\r\n                } catch (JSONException e) {\r\n                    e.printStackTrace();\r\n                    Log.e(TAG, \"Error with JSON parsing: \" + e.getMessage());\r\n                }\r\n            } else {\r\n                Log.e(TAG, \"Error getting reviews from server\");\r\n            }\r\n        }\r\n\r\n        protected abstract void onPostExecute(JSONArray reviews);\r\n    }\r\n\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/binus/pekalongancityguide/Layout/AddDestination.java b/app/src/main/java/com/binus/pekalongancityguide/Layout/AddDestination.java
--- a/app/src/main/java/com/binus/pekalongancityguide/Layout/AddDestination.java	(revision c116bbc908755d46c067728e2622f13525d26cfc)
+++ b/app/src/main/java/com/binus/pekalongancityguide/Layout/AddDestination.java	(date 1681455333033)
@@ -1,8 +1,10 @@
 package com.binus.pekalongancityguide.Layout;
 
+import android.Manifest;
 import android.app.ProgressDialog;
 import android.content.Context;
 import android.content.Intent;
+import android.content.pm.PackageManager;
 import android.graphics.Bitmap;
 import android.net.Uri;
 import android.os.AsyncTask;
@@ -17,6 +19,8 @@
 import androidx.annotation.Nullable;
 import androidx.appcompat.app.AlertDialog;
 import androidx.appcompat.app.AppCompatActivity;
+import androidx.core.app.ActivityCompat;
+import androidx.core.content.ContextCompat;
 
 import com.binus.pekalongancityguide.R;
 import com.binus.pekalongancityguide.databinding.ActivityAddDestinationBinding;
@@ -62,6 +66,7 @@
 public class AddDestination extends AppCompatActivity {
     public static final String TAG = "ADD_IMAGE_TAG";
     private static final int PICK_IMAGE_REQUEST = 1;
+    private static final int REQ_WRITE = 2;
     PlacesClient placesClient;
     ArrayList<String> categoriesTitleArrayList, categoryIdArrayList;
     private ActivityAddDestinationBinding binding;
@@ -79,6 +84,12 @@
         binding = ActivityAddDestinationBinding.inflate(getLayoutInflater());
         setContentView(binding.getRoot());
         firebaseAuth = FirebaseAuth.getInstance();
+        if (ContextCompat.checkSelfPermission(this, Manifest.permission.WRITE_EXTERNAL_STORAGE)
+                != PackageManager.PERMISSION_GRANTED) {
+            ActivityCompat.requestPermissions(this,
+                    new String[]{Manifest.permission.WRITE_EXTERNAL_STORAGE},
+                    REQ_WRITE);
+        }
         loadCategory();
         progressDialog = new ProgressDialog(this);
         progressDialog.setTitle("Please wait");
@@ -94,7 +105,6 @@
         });
 
     }
-
     private void validateData() {
         Log.d(TAG, "validate data : validating data ");
         title = binding.titleEt.getText().toString().trim();
@@ -137,7 +147,7 @@
                             OpeningHours openingHours = place.getOpeningHours();
                             double latitude = place.getLatLng().latitude;
                             double longitude = place.getLatLng().longitude;
-                            double rating = place.getRating();
+                            double rating = place.getRating() != null ? place.getRating() : 0;
                             Log.d(TAG, "Address: " + address);
                             Log.d(TAG, "Latitude: " + latitude);
                             Log.d(TAG, "Longitude: " + longitude);
@@ -175,7 +185,6 @@
             });
         }
     }
-
     private void uploadtoStorage(String placeId, String address, double lat, double lng, double rating, JSONArray reviews, String phoneNumber, List<String> weekday, Place place) {
         Log.d(TAG, "uploadtoStorage : uploading to storage");
         progressDialog.setMessage("Uploading image");
@@ -193,59 +202,47 @@
                     if (bitmap != null) { // Check if bitmap is not null
                         imageUri = bitmapToUri(this, bitmap);
                         Log.d(TAG, "image uri: " + imageUri);
+
                         Glide.with(AddDestination.this)
                                 .load(imageUri)
+                                .placeholder(R.drawable.logo)
                                 .centerCrop()
                                 .into(binding.addPicture);
-                    } else {
-                        // Handle error when bitmap is null
-                    }
-                }).addOnFailureListener(exception -> {
-                    // Handle error
-                    if (exception instanceof ApiException) {
-                        ApiException apiException = (ApiException) exception;
-                        int statusCode = apiException.getStatusCode();
-                        Log.e(TAG, "Place photo not found: " + exception.getMessage());
-                    }
-                });
-            }
-        } else {
-            // Use a default image if imageUri is still null
-            imageUri = Uri.parse("android.resource://" + getPackageName() + "/" + R.drawable.logo);
-        }
-
-// Check if imageUri is still null after the fetchPhoto call
-        if (imageUri == null) {
-            // Handle the case when imageUri is null
-            Log.e(TAG, "Failed to fetch image, using default image");
-            imageUri = Uri.parse("android.resource://" + getPackageName() + "/" + R.drawable.logo);
-        }
-
-// Convert the bitmap to URI and set the image using Glide
-        Glide.with(AddDestination.this)
-                .load(imageUri)
-                .centerCrop()
-                .into(binding.addPicture);
 
-        long timestamp = System.currentTimeMillis();
-        String filePathandName = "Destination/" + timestamp;
-        StorageReference storageReference = FirebaseStorage.getInstance("gs://pekalongan-city-guide-5bf2e.appspot.com").getReference(filePathandName);
-        storageReference.putFile(imageUri)
-                .addOnSuccessListener(taskSnapshot -> {
-                    Log.d(TAG, "on success : Image uploaded to Storage");
-                    Log.d(TAG, "on success : getting image url");
-                    Task<Uri> uriTask = taskSnapshot.getStorage().getDownloadUrl();
-                    while (!uriTask.isSuccessful()) ;
-                    String uploadedImageUrl = "" + uriTask.getResult();
-                    uploadtoDB(uploadedImageUrl, timestamp, placeId, address, lat, lng, rating, reviews, phoneNumber, weekday);
-                })
-                .addOnFailureListener(e -> {
-                    progressDialog.dismiss();
-                    Log.d(TAG, "on Failure : Image upload failed due to " + e.getMessage());
-                    Toast.makeText(AddDestination.this, "Image upload failed due to " + e.getMessage(), Toast.LENGTH_SHORT).show();
-                });
+                        long timestamp = System.currentTimeMillis();
+                        String filePathandName = "Destination/" + timestamp;
+                        StorageReference storageReference = FirebaseStorage.getInstance("gs://pekalongan-city-guide-5bf2e.appspot.com").getReference(filePathandName);
+                        storageReference.putFile(imageUri)
+                                .addOnSuccessListener(taskSnapshot -> {
+                                    progressDialog.dismiss();
+                                    Log.d(TAG, "on success : Image uploaded to Storage");
+                                    Log.d(TAG, "on success : getting image url");
+                                    Task<Uri> uriTask = taskSnapshot.getStorage().getDownloadUrl();
+                                    while (!uriTask.isSuccessful()) ;
+                                    String uploadedImageUrl = "" + uriTask.getResult();
+                                    uploadtoDB(uploadedImageUrl, timestamp, placeId, address, lat, lng, rating, reviews, phoneNumber, weekday);
+                                })
+                                .addOnFailureListener(e -> {
+                                    progressDialog.dismiss();
+                                    Log.d(TAG, "on Failure : Image upload failed due to " + e.getMessage());
+                                    Toast.makeText(AddDestination.this, "Image upload failed due to " + e.getMessage(), Toast.LENGTH_SHORT).show();
+                                });
 
+                    } else {
+
+                    }
+                }).addOnFailureListener(exception -> {
+                    // Handle error
+                    if (exception instanceof ApiException) {
+                        ApiException apiException = (ApiException) exception;
+                        int statusCode = apiException.getStatusCode();
+                        Log.e(TAG, "Place photo not found: " + exception.getMessage());
+                    }
+                });
+            }
+        }
     }
+
 
     private void uploadtoDB(String uploadedImageUrl, long timestamp, String placeId, String address, double desLat, double desLong, double rating, JSONArray reviews, String phoneNumber, List<String> weekday) {
         Log.d(TAG, "uploadtoDB : uploading image to firebase DB");
@@ -423,9 +420,11 @@
         protected void onPostExecute(JSONObject json) {
             if (json != null) {
                 try {
-                    // Extract the details and reviews from the JSON
                     JSONObject result = json.getJSONObject("result");
-                    JSONArray reviews = result.getJSONArray("reviews");
+                    JSONArray reviews = result.optJSONArray("reviews");
+                    if (reviews == null) {
+                        reviews = new JSONArray();
+                    }
                     for (int i = 0; i < reviews.length(); i++) {
                         JSONObject review = reviews.getJSONObject(i);
                         String authorName = review.getString("author_name");
@@ -443,6 +442,8 @@
                 }
             } else {
                 Log.e(TAG, "Error getting reviews from server");
+                JSONArray emptyReviews = new JSONArray();
+                onPostExecute(emptyReviews);
             }
         }
 
Index: app/src/main/res/drawable/distance.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/res/drawable/distance.xml b/app/src/main/res/drawable/distance.xml
new file mode 100644
--- /dev/null	(date 1681447009109)
+++ b/app/src/main/res/drawable/distance.xml	(date 1681447009109)
@@ -0,0 +1,15 @@
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="480.54"
+    android:viewportHeight="480.54">
+  <path
+      android:pathData="M225.28,278.43c0,-48.64 -39.57,-88.21 -88.21,-88.21c-48.64,0 -88.21,39.57 -88.21,88.21c0,14.25 3.4,27.73 9.43,39.65l78.78,162.46l78.79,-162.49C221.88,306.13 225.28,292.67 225.28,278.43zM137.06,327.24c-26.92,0 -48.82,-21.9 -48.82,-48.82s21.9,-48.82 48.82,-48.82c26.92,0 48.82,21.9 48.82,48.82S163.98,327.24 137.06,327.24z"
+      android:fillColor="#000000"/>
+  <path
+      android:pathData="M387.02,0c-24.63,0 -44.67,20.04 -44.67,44.67c0,7.22 1.72,14.04 4.78,20.08l39.89,82.27l39.9,-82.28c3.05,-6.04 4.77,-12.85 4.77,-20.07C431.69,20.04 411.65,0 387.02,0zM387.02,69.39c-13.63,0 -24.72,-11.09 -24.72,-24.72c0,-13.63 11.09,-24.72 24.72,-24.72c13.63,0 24.72,11.09 24.72,24.72C411.74,58.3 400.65,69.39 387.02,69.39z"
+      android:fillColor="#000000"/>
+  <path
+      android:pathData="M348.12,289.79c-1.81,-8.52 -4.17,-16.88 -7.13,-25.08c-3.97,-10.99 -8.74,-21.72 -12.39,-32.84c-6.82,-20.77 4.95,-38.1 7.16,-41.26c3.88,-5.52 8.41,-10.58 13.19,-15.32c9.21,-9.13 19.36,-17.29 29.98,-24.8c-1.32,-2.04 -2.59,-4.1 -3.81,-6.2c-15.28,5.99 -93.85,33.45 -91.94,94.12c0.38,12.16 5.08,23.74 7.98,35.53c1.39,5.68 2.61,11.41 3.35,17.22c0.32,2.61 0.51,5.24 0.73,7.87c0.01,-0.02 0,-0.03 -0.01,-0.05c0.01,0.08 0.2,8.33 -0.16,11.9c-1.15,11.19 -2.8,22.49 -7.52,32.76c-4.39,9.54 -11.01,17.84 -19.19,24.4c-18.72,14.99 -43.51,20.99 -66.91,23.4c-1.11,0.12 -2.23,0.22 -3.34,0.31l-41.78,86.15c20.61,-1.28 41.17,-4.1 61.24,-9.04c23.61,-5.81 46.61,-14.59 67.23,-27.6c20.6,-13 38.31,-30.58 50.1,-51.98c12.34,-22.39 17.28,-48.04 16.23,-73.45C350.75,307.16 349.93,298.31 348.12,289.79z"
+      android:fillColor="#000000"/>
+</vector>
Index: app/src/main/res/layout/list_itinerary.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<androidx.cardview.widget.CardView xmlns:android=\"http://schemas.android.com/apk/res/android\"\r\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\r\n    android:id=\"@+id/itinerary_item_cardview\"\r\n    android:layout_width=\"match_parent\"\r\n    android:layout_height=\"wrap_content\"\r\n    android:layout_margin=\"16dp\"\r\n    android:layout_marginVertical=\"8dp\"\r\n    app:cardBackgroundColor=\"@color/ic_launcher_background\"\r\n    app:cardCornerRadius=\"8dp\"\r\n    app:cardElevation=\"4dp\">\r\n\r\n    <LinearLayout\r\n        android:layout_width=\"match_parent\"\r\n        android:layout_height=\"150dp\"\r\n        android:orientation=\"horizontal\"\r\n        android:layout_gravity=\"center_horizontal\">\r\n\r\n        <LinearLayout\r\n            android:id=\"@+id/itinerary_bg\"\r\n            android:layout_width=\"130dp\"\r\n            android:layout_height=\"match_parent\"\r\n            android:orientation=\"vertical\"\r\n            android:gravity=\"center\"\r\n            android:background=\"@color/palette_4\">\r\n\r\n            <TextView\r\n                android:id=\"@+id/startTimeTextView\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:padding=\"8dp\"\r\n                android:textAppearance=\"?attr/textAppearanceListItem\"\r\n                android:textColor=\"@color/palette_1\"\r\n                android:text=\"start\"\r\n                android:textStyle=\"bold\"\r\n                android:layout_marginTop=\"8dp\"\r\n                android:textAlignment=\"center\" />\r\n\r\n            <com.binus.pekalongancityguide.Misc.DottedLineView\r\n                android:layout_width=\"3dp\"\r\n                android:layout_height=\"50dp\" />\r\n\r\n            <TextView\r\n                android:id=\"@+id/endTimeTextView\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:padding=\"8dp\"\r\n                android:textAppearance=\"?attr/textAppearanceListItem\"\r\n                android:textColor=\"@color/palette_1\"\r\n                android:text=\"end\"\r\n                android:textStyle=\"bold\"\r\n                android:layout_marginTop=\"8dp\"\r\n                android:textAlignment=\"center\" />\r\n\r\n        </LinearLayout>\r\n\r\n        <LinearLayout\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"match_parent\"\r\n            android:orientation=\"vertical\"\r\n            android:padding=\"8dp\">\r\n\r\n            <TextView\r\n                android:id=\"@+id/dateTextView\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:padding=\"8dp\"\r\n                android:text=\"end\"\r\n                android:textAppearance=\"?attr/textAppearanceListItem\"\r\n                android:textColor=\"@color/alfa\"\r\n                android:textStyle=\"italic\"/>\r\n\r\n            <TextView\r\n                android:id=\"@+id/placeNameTextView\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:padding=\"8dp\"\r\n                android:textSize=\"22dp\"\r\n                android:text=\"Name\"\r\n                android:textAppearance=\"?attr/textAppearanceListItem\"\r\n                android:textColor=\"@color/palette_2\"\r\n                android:textStyle=\"bold\"\r\n                android:layout_weight=\"1\" />\r\n\r\n            <LinearLayout\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\">\r\n\r\n                <TextView\r\n                    android:id=\"@+id/distanceTextView\"\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:textSize=\"14dp\"\r\n                    android:layout_marginBottom=\"8dp\"\r\n                    android:layout_marginStart=\"8dp\"\r\n                    android:textAppearance=\"?attr/textAppearanceListItem\"\r\n                    android:textColor=\"@color/palette_3\"\r\n                    android:text=\"distance\"\r\n                    android:layout_weight=\"1\" />\r\n\r\n                <TextView\r\n                    android:id=\"@+id/durationTextView\"\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:text=\"duration\"\r\n                    android:textSize=\"14dp\"\r\n                    android:layout_marginBottom=\"8dp\"\r\n                    android:textAppearance=\"?attr/textAppearanceListItem\"\r\n                    android:textColor=\"@color/palette_3\"\r\n                    android:layout_weight=\"1\" />\r\n\r\n            </LinearLayout>\r\n        </LinearLayout>\r\n\r\n    </LinearLayout>\r\n\r\n\r\n</androidx.cardview.widget.CardView>\r\n\r\n\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/res/layout/list_itinerary.xml b/app/src/main/res/layout/list_itinerary.xml
--- a/app/src/main/res/layout/list_itinerary.xml	(revision c116bbc908755d46c067728e2622f13525d26cfc)
+++ b/app/src/main/res/layout/list_itinerary.xml	(date 1681447009207)
@@ -88,6 +88,9 @@
                 android:orientation="horizontal">
 
                 <TextView
+                    android:drawablePadding="5dp"
+                    android:drawableTint="@color/palette_1"
+                    android:drawableLeft="@drawable/distance"
                     android:id="@+id/distanceTextView"
                     android:layout_width="match_parent"
                     android:layout_height="wrap_content"
@@ -100,6 +103,9 @@
                     android:layout_weight="1" />
 
                 <TextView
+                    android:drawableLeft="@drawable/baseline_access_time_24"
+                    android:drawablePadding="5dp"
+                    android:drawableTint="@color/palette_1"
                     android:id="@+id/durationTextView"
                     android:layout_width="match_parent"
                     android:layout_height="wrap_content"
Index: app/src/main/AndroidManifest.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<manifest xmlns:android=\"http://schemas.android.com/apk/res/android\"\r\n    xmlns:tools=\"http://schemas.android.com/tools\">\r\n\r\n    <uses-permission android:name=\"android.permission.READ_EXTERNAL_STORAGE\" />\r\n    <uses-permission android:name=\"android.permission.WRITE_EXTERNAL_STORAGE\" />\r\n    <uses-permission android:name=\"android.permission.CAMERA\" />\r\n    <uses-permission android:name=\"android.permission.INTERNET\" />\r\n\r\n    <application\r\n        android:allowBackup=\"true\"\r\n        android:dataExtractionRules=\"@xml/data_extraction_rules\"\r\n        android:fullBackupContent=\"@xml/backup_rules\"\r\n        android:icon=\"@mipmap/ic_launcher\"\r\n        android:label=\"@string/app_name\"\r\n        android:roundIcon=\"@mipmap/ic_launcher_round\"\r\n        android:supportsRtl=\"true\"\r\n        android:theme=\"@style/Theme.PekalonganCityGuide\"\r\n        tools:targetApi=\"31\">\r\n        <activity\r\n            android:name=\".Layout.ItineraryList\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.ChangePassword\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Misc.ImageFullscreen\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.NewsDetail\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.DestinationDetailAdmin\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.EditDestination\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.ShowDestinationAdmin\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.AddDestination\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.AddCategory\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.AdminHome\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.CityHistory\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.FoodDetails\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.EditProfile\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.Register\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.DestinationDetails\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.Home\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.MainActivity\"\r\n            android:exported=\"false\" />\r\n        <activity\r\n            android:name=\".Layout.Splash\"\r\n            android:exported=\"true\">\r\n            <intent-filter>\r\n                <action android:name=\"android.intent.action.MAIN\" />\r\n\r\n                <category android:name=\"android.intent.category.LAUNCHER\" />\r\n            </intent-filter>\r\n        </activity>\r\n\r\n        <meta-data\r\n            android:name=\"com.google.android.geo.API_KEY\"\r\n            android:value=\"${MAPS_API_KEY}\" />\r\n    </application>\r\n\r\n</manifest>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/AndroidManifest.xml b/app/src/main/AndroidManifest.xml
--- a/app/src/main/AndroidManifest.xml	(revision c116bbc908755d46c067728e2622f13525d26cfc)
+++ b/app/src/main/AndroidManifest.xml	(date 1681448863760)
@@ -3,7 +3,7 @@
     xmlns:tools="http://schemas.android.com/tools">
 
     <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
-    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
+    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
     <uses-permission android:name="android.permission.CAMERA" />
     <uses-permission android:name="android.permission.INTERNET" />
 
